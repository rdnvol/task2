{% liquid
  render 'breadcrumbs'
  render 'product' with product as product
  render "schema"
%}

{%- assign first_3d_model = product.media | where: "media_type", "model" | first -%}

<script type="application/json" id="product-json">
  {% render 'product-json' %}
</script>

<script>
  class DeferredMedia extends HTMLElement {
  constructor() {
    super();
    const poster = this.querySelector('[id^="Deferred-Poster-"]');
    if (poster != null) {
      console.log('Button pressed')
      poster.addEventListener('click', this.loadContent.bind(this));
    } else {
      window.addEventListener('activeModelSlide', () => this.loadContent());
    }
  }

  loadContent() {
    if (!this.getAttribute('loaded')) {
      const content = document.createElement('div');
      content.appendChild(this.querySelector('template').content.firstElementChild.cloneNode(true));
      this.setAttribute('loaded', true);
      this.appendChild(content.querySelector('video, model-viewer, iframe')).focus();
      this.querySelector('picture').classList.add('hidden')
    }
  }
}


customElements.define('deferred-media', DeferredMedia);
</script>

{%- if first_3d_model -%}
  <script type="application/json" id="ProductJSON-{{ product.id }}">
    {{ product.media | where: 'media_type', 'model' | json }}
  </script>

  <script src="{{ 'product-model.js' | asset_url }}" defer></script>
{%- endif -%}
{% schema %}
{
  "name": "Product Information",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_variant_label",
      "label": "Show variant label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dynamic_button",
      "label": "Show dynamic checkout button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_size_chart",
      "label": "Show size chart",
      "default": true
    },
    {
      "type": "url",
      "id": "size_chart_url",
      "label": "Size chart url"
    }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "vendor",
      "name": "Vendor",
      "limit": 1
    },
    {
      "type": "title",
      "name": "Title",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "default": true,
          "label": "Show dynamic checkout",
          "info": "Using the payment methods available on your store, customers see their preferred option, like PayPal or Apple Pay. [Learn more](https://help.shopify.com/manual/using-themes/change-the-layout/dynamic-checkout)"
        }
      ]
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1
    },
    {
      "type": "share",
      "name": "Social sharing buttons",
      "limit": 1
    }
  ]
}
{% endschema %}
